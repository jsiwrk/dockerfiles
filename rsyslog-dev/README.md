rsyslog-dev
===========
A docker image for building rsyslog v8 from the source code. Allows you to edit the rsyslog source code from your host machine (e.g. using Visual Studio Code) and use the container to compile the code, install the binaries, run tests, etc. The build tools and the rsyslog daemon are installed only in the container and hence do not pollute your development environment.

How to use
----------
1. Clone this repo (for example, in `~/work/dockerfiles`).
1. Create the directory you want to use as your workspace for building rsyslog and the related projects (for example, `~/work/rsyslog`). This directory will be mounted in the container with read-write permissions.
1. Define an alias like the following, and place it in your `~/.bashrc` file. You will use this alias to start the container. The `RSD_WORK_DIR` variable must reference the directory you have created in the previous step.
    ```
    alias rsd='RSD_WORK_DIR=~/work/rsyslog ~/work/dockerfiles/rsyslog-dev/start.sh'
    ```
    Optionally, you can also include the variable `RSD_CONFIG_DIR` in the alias definition. This variable must reference a directory containing a rsyslog configuration file named `rsyslog.conf` and a directory `rsyslog.d`. Both will be mounted in the container as read-only. For example:
    ```
    alias rsd='RSD_WORK_DIR=~/work/rsyslog RSD_CONFIG_DIR=~/work/rsyslog/test/config ~/work/dockerfiles/rsyslog-dev/start.sh'
    ```
    If the `RSD_CONFIG_DIR` variable is not specified, it defaults to the `etc` directory included in this project (`~/work/dockerfiles/rsyslog-dev/etc`), which contains a sample rsyslog configuration. 
1. Now you can start the container by simply typing the alias. The first time it will take a while for the container to start, since the image needs to be built.
    ```
    rsd
    ```
1. When the following prompt appears, you are inside the rsyslog-dev container.
    ```
    yourname@rsyslog:~/work/rsyslog$ 
    ```
1. Inside the container, type the following command to build rsyslog from the source code. This will clone the master branch of the rsyslog repository from GitHub.
    ```
    yourname@rsyslog:~/work/rsyslog$ build
    ```
1. Inside the container you also have shortcuts for running the tests, installing the rsyslogd binaries, running rsyslog, generating the documentation, etc. Type `rsd --help` in your host machine for details.
1. To exit the container, just type `exit`. This will not stop the container, but only your bash session within the container. Type `rsd` again to open another bash session in the container.

Options for starting the container
----------------------------------
The `rsd` command (or whatever alias you have chosen) accepts options for forcing a rebuild of the Docker image, restarting the container, and others. Type `rsd --help` for details. Example:
    ```
    rsd --restart
    ```

Environment variables inside the container
------------------------------------------
The first time you run the `rsd` command, it will create a file `.rsd_env` in your workspace (for example, `~/work/rsyslog/.rsd_env`). The variables you define in this file will be visible as environment variables inside the container. If you change this file, the `rsd` command will automatically restart the container.

The `WORK_DIR` variable is also defined inside the container, with the same value as the `RSD_WORK_DIR` variable included in the `rsd` alias definition.

File locations and permissions
------------------------------
The container uses the same user and group you have in your host machine, and mounts the workspace directory as read-write. Therefore the files created within the container are directly editable from your host machine, and viceversa (except for the files created by rsyslog itself, as explained below).

You can also tune the rsyslog configuration to read and write files located in your workspace (e.g. input log files, a debug log...). For example:
```
input(
    type="imfile"
    file=`echo $WORK_DIR/test/data/logs.in`
    tag="testlog"
)

action(
    type="omfile"
    file=`echo $WORK_DIR/test/data/logs.out`
)
```

See a more complete example in the sample configuration included in the `etc` directory of this project.

Note that rsyslogd needs to run with sudo privileges within the container. This means that the files generated by rsyslogd will be owned by root. Some of these files are created with read permissions for everybody, but others don't (*). In the latter case, if you want to view the file from your host machine (e.g. from an editor), you will need to execute `sudo chown $USER:$USER <file>` to fix the owner first.

(*) Noticeably, the rsyslog debug file is created with `600` permissions. A permissive sudo umask is used inside the container, but apparently rsyslog ignores it.

Further info
------------
Documentation on how to build rsyslog from sources:
* http://www.rsyslog.com/doc/v8-stable/installation/install_from_source.html
* http://www.rsyslog.com/doc/v8-stable/installation/build_from_repo.html
* http://www.rsyslog.com/doc/build_from_repo.html
